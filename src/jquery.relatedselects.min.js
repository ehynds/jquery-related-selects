/*
 * jQuery Related Selects plug-in 1.0
 *
 * http://www.erichynds.com/jquery/jquery-related-dependent-selects-plugin/
 * http://github.com/ehynds/jquery-related-selects
 *
 * Copyright (c) 2009 Eric Hynds
 * Edited by Mark Walker 2011 (included ability to have mulitple related-selects within the same form)
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 */
(function(a){a.fn.relatedSelects=function(c){c=a.extend({},a.fn.relatedSelects.defaults,c);return this.each(function(){new b(this,c)})};var b=function(f,c){var l=a(f),m=[];if(typeof c.selectSets!="undefined"){a.each(c.selectSets,function(p){c.onChangeLoad=this.onChangeLoad;c.selects=this.selects;o(f,c,p)})}else{o(f,c,0)}function o(s,t,r){var p=a(s),q=[];if(a.isArray(t.selects)){d()}a.each(t.selects,function(u){m.push({name:u,set:r})});j();a.each(t.selects,function(x,y){var v=p.find("select[name='"+x+"']"),u=i(x,r),w=v.val();y=a.extend({defaultOptionText:t.defaultOptionText||v.data("defaultOption")},t,y);v.data("defaultOption",y.defaultOptionText);v.change(function(){y.onChange.call(v);e(v,u,x,y,r)});if(w&&w.length>0&&h(u)){return}e(v,u,x,y,r)})}function j(){var r,s;for(var q=1,p=m.length;q<p;q++){r=l.find("select[name='"+m[q]+"']");s=r.find("option[value='']").text();r.data("defaultOption",s)}}function e(r,p,s,u,q){if(!p.length){return}var t=a.trim(r.val());if(t.length>0&&t!==u.loadingMessage&&p){g(s,q);k(r,p,u,q)}else{if(p){g(s,q)}}}function k(u,s,w,r){var t=[],v;for(var q=0,p=m.length;q<p;q++){if(m[q]["set"]!=r){continue}t.push('select[name="'+m[q]["name"]+'"]')}v=a(t.join(","),l).serialize();s.attr("disabled","disabled").html('<option value="">'+w.loadingMessage+"</option>");a.ajax({beforeSend:function(){w.onLoadingStart.call(s)},complete:function(){w.onLoadingEnd.call(s)},dataType:w.dataType,data:v,url:w.onChangeLoad,success:function(y){var x=[],z=s.data("defaultOption");if(z.length>0){x.push('<option value="" selected="selected">'+z+"</option>")}if(w.dataType==="json"&&typeof y==="object"&&y){a.each(y,function(A,B){x.push('<option value="'+A+'">'+B+"</option>")});s.html(x.join("")).removeAttr("disabled")}else{if(w.dataType==="html"&&a.trim(y).length>0){x.push(a.trim(y));s.html(x.join("")).removeAttr("disabled")}else{s.html(x.join(""));if(!w.disableIfEmpty){s.removeAttr("disabled")}w.onEmptyResult.call(u)}}}})}function h(q){var p=q.find("option");return(p.length===0||(p.length===1&&p.filter(":first").attr("value").length===0))?false:true}function g(t,r){var s=n(t,r);for(var q=s+1,p=m.length;q<p;q++){if(m[q]["set"]!=r){continue}a("select[name='"+m[q]["name"]+"']",l).attr("disabled","disabled").find("option:first").attr("selected","selected")}}function i(q,p){if(typeof m[n(q,p)+1]=="undefined"){return l.find("select[name='undefined']")}else{return l.find("select[name='"+m[n(q,p)+1]["name"]+"']")}}function n(s,q){for(var r=0,p=m.length;r<p;r++){if(m[r]["name"]===s&&m[r]["set"]==q){return r}}}function d(){var r=c.selects;c.selects={};for(var q=0,p=r.length;q<p;q++){c.selects[r[q]]={}}}};a.fn.relatedSelects.defaults={selects:{},loadingMessage:"Loading, please wait...",disableIfEmpty:false,dataType:"json",onChangeLoad:"",onLoadingStart:function(){},onLoadingEnd:function(){},onChange:function(){},onEmptyResult:function(){},defaultOptionText:"Select...."}})(jQuery);